rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidPhoneNumber(phone) {
      return phone is string && phone.matches('^[0-9]{10,15}$');
    }

    function isValidEmail(email) {
      return email is string && email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    function isValidBookingStatus(status) {
      return status in ['pending', 'confirmed', 'in-progress', 'completed', 'cancelled'];
    }

    function isValidVehicleType(type) {
      return type in ['sedan', 'suv', 'truck', 'van', 'motorcycle'];
    }

    function isValidPackage(package) {
      return package in ['basic', 'premium', 'deluxe', 'diamond'];
    }

    // Users collection
    match /users/{userId} {
      // Allow read if authenticated user is the owner
      allow read: if isOwner(userId);

      // Allow create only if authenticated and creating own document
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasAll(['phoneNumber', 'createdAt'])
        && isValidPhoneNumber(request.resource.data.phoneNumber)
        && request.resource.data.createdAt is timestamp
        && (!('email' in request.resource.data) || isValidEmail(request.resource.data.email))
        && (!('name' in request.resource.data) || request.resource.data.name is string)
        && (!('language' in request.resource.data) || request.resource.data.language in ['en', 'ar'])
        && (!('loyaltyPoints' in request.resource.data) || request.resource.data.loyaltyPoints is int)
        && (!('totalBookings' in request.resource.data) || request.resource.data.totalBookings is int);

      // Allow update only if authenticated and updating own document
      // Cannot change phoneNumber or createdAt
      allow update: if isOwner(userId)
        && request.resource.data.phoneNumber == resource.data.phoneNumber
        && request.resource.data.createdAt == resource.data.createdAt
        && (!('email' in request.resource.data) || isValidEmail(request.resource.data.email))
        && (!('name' in request.resource.data) || request.resource.data.name is string)
        && (!('language' in request.resource.data) || request.resource.data.language in ['en', 'ar']);

      // Prevent deletion of user documents
      allow delete: if false;
    }

    // Bookings collection
    match /bookings/{bookingId} {
      // Allow read if authenticated user is the owner
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Allow create if authenticated and valid data
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll([
          'userId', 'packageName', 'vehicleType', 'price',
          'address', 'phoneNumber', 'status', 'createdAt'
        ])
        && isValidBookingStatus(request.resource.data.status)
        && request.resource.data.status == 'pending'
        && isValidVehicleType(request.resource.data.vehicleType)
        && isValidPackage(request.resource.data.packageName)
        && request.resource.data.price is number
        && request.resource.data.price >= 0
        && request.resource.data.address is string
        && request.resource.data.address.size() > 0
        && isValidPhoneNumber(request.resource.data.phoneNumber)
        && request.resource.data.createdAt is timestamp
        && (!('scheduledDate' in request.resource.data) || request.resource.data.scheduledDate is timestamp)
        && (!('scheduledTime' in request.resource.data) || request.resource.data.scheduledTime is string)
        && (!('notes' in request.resource.data) || request.resource.data.notes is string);

      // Allow update if authenticated user is the owner
      // Can only update certain fields, cannot change userId or createdAt
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.createdAt == resource.data.createdAt
        && (!('status' in request.resource.data) || isValidBookingStatus(request.resource.data.status))
        && (!('address' in request.resource.data) || request.resource.data.address is string)
        && (!('phoneNumber' in request.resource.data) || isValidPhoneNumber(request.resource.data.phoneNumber))
        && (!('notes' in request.resource.data) || request.resource.data.notes is string);

      // Allow delete only if booking is in pending or cancelled status
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && resource.data.status in ['pending', 'cancelled'];
    }

    // Loyalty collection (sub-collection under users)
    match /users/{userId}/loyalty/{loyaltyId} {
      // Allow read if authenticated user is the owner
      allow read: if isOwner(userId);

      // Allow create only by the user for their own loyalty records
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasAll(['count', 'lastUpdated'])
        && request.resource.data.count is int
        && request.resource.data.count >= 0
        && request.resource.data.lastUpdated is timestamp;

      // Allow update only by the user
      allow update: if isOwner(userId)
        && request.resource.data.count is int
        && request.resource.data.count >= 0
        && request.resource.data.lastUpdated is timestamp;

      // Prevent deletion
      allow delete: if false;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
